<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Pedido Premium | Revendedor 3Fit</title>
  <meta name="description" content="Monte seu pedido de marmitas 3Fit em uma experi√™ncia r√°pida, premium e profissional." />
  <link rel="icon" type="image/png" href="./images/logo.png" />
  <link rel="shortcut icon" href="./images/logo.png" />
  <link rel="apple-touch-icon" href="./images/logo.png" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
  <style>
    :root {
      --bg: #f8f6f4;
      --surface: #ffffff;
      --surface-soft: #fff8f2;
      --text: #171513;
      --text-soft: #5a5149;
      --text-strong: #221e1a;
      --text-strong-soft: #2b231d;
      --text-soft-strong: #5d5249;
      --text-muted-strong: #4d433a;
      --title-strong: #2c241c;
      --chip-muted: #5e5750;
      --primary: #e86f0d;
      --primary-strong: #be5908;
      --accent: #e86f0d;
      --accent-text: #b85a0a;
      --line: #eadfd3;
      --line-subtle: rgba(0, 0, 0, 0.06);
      --line-accent: #f0b788;
      --line-accent-soft: #f2c7a4;
      --ring-accent-soft: #ffe6d1;
      --surface-muted: #fffaf6;
      --surface-accent-soft: #fff3e8;
      --surface-notice: #fff7f1;
      --surface-chip: #fff0e4;
      --meter-track: #f2ded0;
      --ok: #923f00;
      --ok-bg: #fff3e6;
      --ok-line: #f3c8a3;
      --danger: #c23939;
      --danger-bg: #ffecec;
      --danger-line: #f1c4c4;
      --radius-lg: 18px;
      --radius-md: 12px;
      --shadow: 0 10px 30px rgba(23, 21, 19, 0.1);
      --shadow-sm: 0 6px 14px rgba(23, 21, 19, 0.12);
      --shadow-card: 0 8px 18px rgba(23, 21, 19, 0.12);
      --shadow-primary-lg: 0 10px 20px rgba(232, 111, 13, 0.33);
      --shadow-primary-sm: 0 6px 12px rgba(232, 111, 13, 0.24);
      --shadow-modal: 0 20px 50px rgba(23, 21, 19, 0.24);
      --shadow-dock: 0 14px 28px rgba(23, 21, 19, 0.2);
      --overlay-backdrop: rgba(13, 24, 14, 0.55);
      --overlay-panel: rgba(255, 255, 255, 0.95);
      --gradient-primary: linear-gradient(135deg, var(--primary), var(--primary-strong));
      --gradient-progress: linear-gradient(90deg, #ffae6a, var(--accent));
      --gradient-media-overlay: linear-gradient(180deg, rgba(0, 0, 0, 0.02), rgba(0, 0, 0, 0.3));
      --gradient-hero-glow: radial-gradient(circle, rgba(239, 108, 0, 0.17), transparent 70%);
      --gradient-hero-border: linear-gradient(120deg, rgba(239, 108, 0, 0.2), rgba(255, 182, 118, 0.24), rgba(23, 21, 19, 0.08));
      --gradient-bg-layer-1: radial-gradient(circle at 8% 2%, rgba(239, 108, 0, 0.13), transparent 33%);
      --gradient-bg-layer-2: radial-gradient(circle at 90% 0%, rgba(0, 0, 0, 0.06), transparent 31%);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: "Montserrat", sans-serif;
      color: var(--text);
      background: var(--gradient-bg-layer-1), var(--gradient-bg-layer-2), var(--bg);
      line-height: 1.4;
      overflow-x: hidden;
    }

    .container {
      width: min(1160px, calc(100% - 28px));
      margin: 0 auto;
    }

    .topbar {
      padding: 18px 0;
      border-bottom: 1px solid var(--line-subtle);
      backdrop-filter: blur(4px);
    }

    .topbar__wrap {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 14px;
      flex-wrap: wrap;
    }

    .topbar__actions {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      margin-left: auto;
    }

    .brand {
      display: inline-flex;
      align-items: center;
      gap: 12px;
      text-decoration: none;
      color: inherit;
    }

    .brand img {
      width: 54px;
      height: 54px;
      border-radius: 10px;
      background: #fff;
      object-fit: contain;
      border: 1px solid var(--line);
    }

    .brand strong {
      display: block;
      font-size: 1.05rem;
      line-height: 1.1;
    }

    .brand span {
      font-size: 0.84rem;
      color: var(--text-soft);
    }

    .pill {
      border: 1px solid var(--line);
      border-radius: 999px;
      padding: 9px 12px;
      font-size: 0.8rem;
      background: #fff;
      color: var(--text-soft);
    }

    .cart-btn {
      position: relative;
      width: 46px;
      height: 46px;
      border: 1px solid var(--line);
      background: #fff;
      border-radius: 12px;
      cursor: pointer;
      box-shadow: var(--shadow-sm);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      color: var(--text-strong);
      font-size: 1.2rem;
    }

    .cart__count {
      position: absolute;
      top: -6px;
      right: -6px;
      min-width: 20px;
      height: 20px;
      padding: 0 5px;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 0.68rem;
      font-weight: 800;
      background: var(--chip-muted);
      color: #fff;
      border: 2px solid #fff;
    }

    .cart-btn.has-items .cart__count {
      background: var(--accent);
    }

    .hero {
      padding: 34px 0 22px;
    }

    .hero__content {
      display: grid;
      grid-template-columns: 1.1fr 0.9fr;
      gap: 20px;
      align-items: stretch;
    }

    .hero__left {
      background: var(--surface);
      border: 1px solid var(--line);
      border-radius: var(--radius-lg);
      padding: clamp(20px, 3vw, 34px);
      box-shadow: var(--shadow);
      position: relative;
      overflow: hidden;
      animation: heroFadeIn .55s ease both;
    }

    .hero__left::after {
      content: "";
      width: 210px;
      height: 210px;
      background: var(--gradient-hero-glow);
      position: absolute;
      bottom: -85px;
      right: -70px;
      pointer-events: none;
    }

    .hero__left::before {
      content: "";
      position: absolute;
      inset: -2px;
      border-radius: inherit;
      background: var(--gradient-hero-border);
      opacity: 0;
      z-index: 0;
      pointer-events: none;
      transition: opacity .25s ease;
    }

    .hero__left:hover::before {
      opacity: 1;
    }

    .hero__left > * {
      position: relative;
      z-index: 1;
    }

    @keyframes heroFadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .hero h1 {
      margin: 12px 0 12px;
      font-size: clamp(1.5rem, 3vw, 2.3rem);
      line-height: 1.18;
      max-width: 24ch;
    }

    .hero__highlight {
      color: var(--accent);
      font-weight: 900;
      text-shadow: 0 1px 0 rgba(255, 255, 255, 0.35);
    }

    .hero__highlight-wrap {
      white-space: nowrap;
    }

    .hero p {
      color: var(--text-soft);
      margin: 0;
      max-width: 62ch;
    }

    .hero__promo {
      margin-top: 18px;
      display: grid;
      gap: 8px;
      max-width: 500px;
    }

    .hero__promo-card {
      border: 1px solid var(--line);
      border-radius: 11px;
      background: #fff;
      padding: 8px 10px;
      display: grid;
      grid-template-columns: minmax(0, 1fr) auto;
      gap: 8px;
      font-size: 0.84rem;
      align-items: center;
    }

    .hero__promo-card strong {
      color: var(--title-strong);
      font-weight: 800;
    }

    .hero__promo-card span {
      color: var(--accent-text);
      font-weight: 700;
    }

    .btn {
      border: 0;
      border-radius: 11px;
      padding: 12px 16px;
      font: inherit;
      font-weight: 700;
      cursor: pointer;
      transition: transform .18s ease, box-shadow .18s ease;
    }

    .btn:hover { transform: translateY(-1px); }
    .btn:disabled {
      opacity: 0.72;
      cursor: not-allowed;
      transform: none;
    }

    .btn--primary {
      background: var(--gradient-primary);
      color: #fff;
      box-shadow: var(--shadow-primary-lg);
    }

    .btn--ghost {
      background: #fff;
      color: var(--text);
      border: 1px solid var(--line);
    }

    #clearOrderBtn {
      position: relative;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      white-space: nowrap;
      padding-right: 28px;
    }

    #clearOrderBtn .clear-order-label {
      white-space: nowrap;
    }

    #clearOrderBtn .clear-order-ok {
      position: absolute;
      right: 10px;
      width: 1.1em;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transform: scale(0.6);
      color: var(--accent-text);
    }

    #clearOrderBtn.is-done {
      border-color: var(--line-accent-soft);
      background: var(--surface-accent-soft);
      color: var(--accent-text);
    }

    #clearOrderBtn.is-done .clear-order-ok {
      animation: clearOrderCheck .65s cubic-bezier(.22, .7, .25, 1) forwards;
    }

    @keyframes clearOrderCheck {
      0% {
        opacity: 0;
        transform: scale(0.3) rotate(-20deg);
      }
      55% {
        opacity: 1;
        transform: scale(1.18) rotate(0deg);
      }
      100% {
        opacity: 1;
        transform: scale(1);
      }
    }

    .hero__cover {
      position: relative;
      border-radius: var(--radius-lg);
      overflow: hidden;
      border: 1px solid var(--line);
      box-shadow: var(--shadow);
      min-height: 320px;
      background: #000;
    }

    .hero__cover img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
      opacity: 0.86;
    }

    .hero__cover::after {
      content: "";
      position: absolute;
      inset: 0;
      background: var(--gradient-media-overlay);
      pointer-events: none;
    }

    .layout {
      display: grid;
      grid-template-columns: 1fr 360px;
      gap: 18px;
      align-items: start;
      padding-bottom: 50px;
    }

    .panel {
      background: var(--surface);
      border: 1px solid var(--line);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow);
    }

    .products {
      padding: 14px;
      min-width: 0;
    }

    .field {
      width: 100%;
      padding: 12px;
      border-radius: 10px;
      border: 1px solid var(--line);
      background: #fff;
      font: inherit;
      color: var(--text);
    }

    .albums {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 10px;
      margin-bottom: 12px;
      min-width: 0;
    }

    .album {
      border: 1px solid var(--line);
      border-radius: 12px;
      background: #fff;
      overflow: hidden;
      cursor: pointer;
      text-align: left;
      padding: 0;
      font: inherit;
      transition: transform .15s ease, box-shadow .15s ease;
    }

    .album:hover {
      transform: translateY(-1px);
      box-shadow: var(--shadow-card);
    }

    .album.active {
      border-color: var(--line-accent);
      box-shadow: 0 0 0 2px var(--ring-accent-soft);
    }

    .album img {
      width: 100%;
      aspect-ratio: 16 / 10;
      object-fit: cover;
      display: block;
      border-bottom: 1px solid var(--line);
    }

    .album__meta {
      padding: 10px;
      display: grid;
      gap: 4px;
    }

    .album__meta strong {
      font-size: 0.84rem;
      letter-spacing: .03em;
      color: var(--text-strong-soft);
    }

    .album__meta span {
      font-size: 0.78rem;
      color: var(--text-soft);
    }

    .album-head {
      display: flex;
      align-items: center;
      justify-content: flex-start;
      gap: 10px;
      margin-bottom: 10px;
    }

    .album-head h3 {
      margin: 0;
      font-size: 0.98rem;
    }

    .album-clear {
      border: 1px solid var(--line);
      border-radius: 10px;
      background: #fff;
      color: var(--text-muted-strong);
      padding: 8px 10px;
      font: inherit;
      cursor: pointer;
      font-size: 0.8rem;
      font-weight: 600;
    }

    .product-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 10px;
      max-height: 690px;
      overflow: auto;
      padding-right: 2px;
    }

    .product {
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 10px;
      background: var(--surface-soft);
      display: flex;
      flex-direction: column;
      gap: 9px;
    }

    .product small {
      color: var(--accent-text);
      font-weight: 700;
      font-size: 0.72rem;
      letter-spacing: .03em;
      text-transform: uppercase;
    }

    .product h3 {
      margin: 0;
      font-size: .92rem;
      line-height: 1.28;
      min-height: calc(1.28em * 3);
      max-height: calc(1.28em * 3);
      overflow: hidden;
      display: -webkit-box;
      -webkit-box-orient: vertical;
      -webkit-line-clamp: 3;
      line-clamp: 3;
    }

    .product__price {
      font-size: 0.84rem;
      margin-top: -2px;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 2px;
      line-height: 1.2;
    }

    .product__price-current {
      color: var(--text-strong-soft);
    }

    .product__price-max-discount {
      color: var(--text-soft-strong);
      font-size: 0.73rem;
      font-weight: 600;
    }

    .qty {
      margin-top: auto;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      border: 1px solid var(--line);
      border-radius: 10px;
      background: #fff;
      padding: 4px;
      width: fit-content;
    }

    .qty button {
      border: 0;
      width: 30px;
      height: 30px;
      border-radius: 8px;
      font-size: 1rem;
      cursor: pointer;
      font-weight: 700;
      background: var(--surface-chip);
      color: var(--accent-text);
    }

    .qty input {
      border: 0;
      width: 32px;
      text-align: center;
      font-weight: 700;
      font: inherit;
      color: var(--text);
      background: transparent;
      appearance: textfield;
    }

    .qty input::-webkit-outer-spin-button,
    .qty input::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    .sidebar {
      padding: 14px;
      position: sticky;
      top: 10px;
      min-width: 0;
    }

    .sidebar h2 {
      margin: 0 0 10px;
      font-size: 1.03rem;
    }

    .summary {
      border: 1px dashed var(--line-accent);
      background: var(--surface-muted);
      border-radius: 10px;
      padding: 10px;
      margin-bottom: 12px;
      max-height: none;
      overflow: visible;
    }

    .summary__disclaimer {
      margin: 8px 0 0;
      font-size: 0.75rem;
      line-height: 1.35;
      color: var(--text-soft);
    }

    .summary__line {
      display: grid;
      grid-template-columns: minmax(0, 1fr) auto;
      align-items: start;
      gap: 10px;
      font-size: .85rem;
      margin-bottom: 8px;
      line-height: 1.32;
    }

    .summary__item-name {
      min-width: 0;
      white-space: normal;
      overflow-wrap: normal;
      word-break: normal;
      hyphens: none;
      color: var(--text-strong-soft);
    }

    #reviewSummary .summary__item-name--dish {
      display: block;
      white-space: normal;
      overflow-wrap: anywhere;
      word-break: normal;
      line-height: 1.25;
    }

    #reviewSummary .summary__line--dish {
      align-items: center;
      margin-bottom: 6px;
      padding-bottom: 5px;
      border-bottom: 1px dashed var(--line);
    }

    .summary__item-meta {
      font-weight: 700;
      color: var(--accent-text);
      white-space: nowrap;
      text-align: right;
    }

    .summary__group {
      border: 1px solid var(--line);
      border-radius: 8px;
      background: #fff;
      padding: 8px;
      margin-bottom: 8px;
    }

    .summary__group-title {
      display: grid;
      grid-template-columns: minmax(0, 1fr) auto;
      align-items: start;
      gap: 10px;
      margin-bottom: 6px;
      font-size: 0.78rem;
      font-weight: 800;
      color: var(--accent-text);
      letter-spacing: .02em;
      text-transform: uppercase;
    }

    .summary__subtotal {
      border-top: 1px dashed var(--line);
      margin-top: 6px;
      padding-top: 6px;
      font-size: 0.78rem;
      color: var(--text-soft-strong);
      display: grid;
      grid-template-columns: minmax(0, 1fr) auto;
      gap: 10px;
      font-weight: 700;
    }

    .total {
      margin-top: 8px;
      padding-top: 8px;
      border-top: 1px solid var(--line);
      font-weight: 700;
    }

    .summary > .summary__line.total:first-child {
      margin-top: 0;
      padding-top: 0;
      border-top: 0;
    }

    .summary__meters {
      margin-top: 8px;
      display: grid;
      gap: 6px;
    }

    .summary__meter-note {
      margin: 0 0 2px;
      font-size: 0.76rem;
      line-height: 1.2;
      font-weight: 700;
      color: var(--accent-text);
    }

    .summary__meter-disclaimer {
      margin: 4px 0 0;
      font-size: 0.75rem;
      line-height: 1.3;
      color: var(--text-soft);
    }

    .summary__meter {
      display: grid;
      gap: 4px;
    }

    .summary__meter-top {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      font-size: 0.78rem;
      font-weight: 700;
      color: var(--text-soft-strong);
    }

    .summary__meter-pct {
      color: var(--accent-text);
      font-weight: 800;
    }

    .summary__meter-track {
      height: 8px;
      border-radius: 999px;
      background: var(--meter-track);
      overflow: hidden;
    }

    .summary__meter-fill {
      height: 100%;
      border-radius: inherit;
      background: var(--gradient-progress);
      transition: width .2s ease;
    }

    .form {
      display: grid;
      gap: 9px;
    }

    .form textarea {
      min-height: 74px;
      resize: vertical;
    }

    .actions {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin-top: 8px;
      margin-bottom: 10px;
    }

    .actions .btn {
      padding: 10px 12px;
      font-size: 0.95rem;
      line-height: 1.15;
      min-height: 52px;
      white-space: nowrap;
    }

    .actions .btn--primary {
      box-shadow: var(--shadow-primary-sm);
    }

    .notice {
      margin: 0;
      border: 1px solid var(--line-accent-soft);
      background: var(--surface-notice);
      border-radius: 12px;
      padding: 10px;
    }

    .offer__title {
      margin: 0 0 6px;
      font-size: 0.76rem;
      font-weight: 800;
      color: var(--accent-text);
      letter-spacing: 0.02em;
      text-transform: uppercase;
    }

    .offer__hero {
      margin: 0 0 8px;
      border: 1px solid var(--line);
      border-radius: 10px;
      background: #fff;
      padding: 8px;
    }

    .offer__hero-strong {
      margin: 0 0 2px;
      font-size: 1.03rem;
      font-weight: 800;
      color: var(--accent-text);
      line-height: 1.15;
    }

    .offer__hero-sub {
      margin: 0;
      font-size: 0.79rem;
      color: var(--text-soft);
      line-height: 1.22;
      font-weight: 600;
      letter-spacing: 0.003em;
    }

    .offer__grid {
      display: grid;
      gap: 6px;
      margin-bottom: 8px;
    }

    .offer__card {
      border: 1px solid var(--line);
      border-radius: 10px;
      background: #fff;
      padding: 7px 8px;
      display: grid;
      grid-template-columns: minmax(0, 1fr) auto;
      gap: 8px;
      font-size: 0.76rem;
    }

    .offer__card strong {
      color: var(--title-strong);
      font-weight: 700;
    }

    .offer__card span {
      color: var(--text-soft);
    }

    .offer__card-prefix {
      font-size: 0.82em;
      margin-right: 3px;
    }

    .offer__card.active {
      border-color: var(--line-accent);
      background: var(--surface-accent-soft);
    }

    .offer__card.active strong {
      color: var(--accent-text);
    }

    .offer__status {
      margin: 0;
      font-size: 0.74rem;
      color: var(--text-soft);
      line-height: 1.2;
      font-weight: 700;
    }

    .offer__status--hit {
      color: var(--accent-text);
      font-size: 0.8rem;
      line-height: 1.24;
    }

    .offer__meters + .offer__status {
      margin-top: 8px;
    }

    .offer__status + .offer__status {
      margin-top: 4px;
    }

    .offer__status--target {
      font-size: 0.71rem;
      letter-spacing: -0.01em;
    }

    @media (min-width: 1025px) {
      .offer__status--target {
        white-space: nowrap;
      }
    }

    .offer__meters {
      display: grid;
      gap: 7px;
      margin-top: 6px;
    }

    .offer__meter {
      display: grid;
      gap: 4px;
    }

    .offer__meter-top {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      font-size: 0.72rem;
      color: var(--text-soft-strong);
      font-weight: 700;
    }

    .offer__track {
      height: 8px;
      border-radius: 999px;
      background: var(--meter-track);
      overflow: hidden;
    }

    .offer__fill {
      height: 100%;
      background: var(--gradient-progress);
      border-radius: inherit;
      transition: width .2s ease;
    }

    .alert-modal__card {
      width: min(420px, 100%);
      padding: 16px;
    }

    .alert-modal__card h3 {
      margin: 0 0 8px;
      font-size: 1rem;
    }

    .alert-modal__message {
      margin: 0;
      font-size: 0.92rem;
      line-height: 1.45;
    }

    .alert-modal__card.error {
      background: var(--danger-bg);
      border-color: var(--danger-line);
      color: var(--danger);
    }

    .alert-modal__card.ok {
      background: var(--ok-bg);
      border-color: var(--ok-line);
      color: var(--ok);
    }

    .alert-modal__actions {
      margin-top: 12px;
      display: flex;
      justify-content: flex-end;
    }

    .alert-modal__ok {
      min-width: 96px;
      min-height: 40px;
      padding: 8px 14px;
    }

    .modal {
      position: fixed;
      inset: 0;
      background: var(--overlay-backdrop);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 16px;
      z-index: 70;
    }

    .modal.show {
      display: flex;
    }

    .modal__card {
      width: min(500px, 100%);
      max-height: 92vh;
      overflow: auto;
      background: #fff;
      border: 1px solid var(--line);
      border-radius: 16px;
      box-shadow: var(--shadow-modal);
      padding: 14px;
    }

    .modal__head {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-bottom: 10px;
    }

    .modal__head h3 {
      margin: 0;
      font-size: 1rem;
    }

    .modal__close {
      border: 1px solid var(--line);
      background: #fff;
      color: var(--text-muted-strong);
      border-radius: 10px;
      font: inherit;
      font-weight: 700;
      padding: 7px 10px;
      cursor: pointer;
    }

    .modal__actions {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin-top: 10px;
    }

      .mobile-dock {
        display: none;
      }

    @media (max-width: 1030px) {
      .layout { grid-template-columns: 1fr; }
      .sidebar { position: static; }
      .hero__content { grid-template-columns: 1fr; }
      .hero__cover { min-height: 230px; }

      .mobile-dock {
        display: grid;
        grid-template-columns: minmax(0, 1fr) auto;
        gap: 8px;
        align-items: center;
        position: fixed;
        left: 10px;
        right: 10px;
        bottom: 10px;
        z-index: 60;
        border: 1px solid var(--line-accent-soft);
        background: var(--overlay-panel);
        backdrop-filter: blur(4px);
        border-radius: 14px;
        box-shadow: var(--shadow-dock);
        padding: 9px;
        transition: opacity .2s ease, transform .2s ease;
      }

      .mobile-dock.is-hidden {
        opacity: 0;
        transform: translateY(14px);
        pointer-events: none;
      }

      .mobile-dock__meta {
        font-size: 0.8rem;
        color: var(--text-strong-soft);
        font-weight: 700;
        line-height: 1.25;
        white-space: pre-line;
        transition: opacity .2s ease, max-height .2s ease, margin .2s ease;
        max-height: 40px;
      }

      .mobile-dock__meta-highlight {
        color: var(--accent-text);
      }

      .mobile-dock__meta-note {
        position: absolute;
        left: 10px;
        top: 52px;
        font-size: 0.62rem;
        line-height: 1;
        font-weight: 700;
        color: var(--accent-text);
        transition: opacity .2s ease;
        opacity: 1;
        pointer-events: none;
      }

      .mobile-dock__meta-note.is-hidden {
        opacity: 0;
      }

      .mobile-dock__meta.is-hidden {
        opacity: 0;
        max-height: 0;
        margin: 0;
        overflow: hidden;
        pointer-events: none;
      }

      .mobile-dock__meters {
        grid-column: 1 / -1;
        display: grid;
        gap: 4px;
      }

      .mobile-dock__meter-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 8px;
        font-size: 0.68rem;
        color: var(--text-soft-strong);
        font-weight: 700;
      }

      .mobile-dock__meter {
        height: 6px;
        border-radius: 999px;
        background: var(--meter-track);
        overflow: hidden;
      }

      .mobile-dock__fill {
        height: 100%;
        width: 0%;
        border-radius: inherit;
        background: var(--gradient-progress);
        transition: width .2s ease;
      }

      .mobile-dock .btn {
        min-height: 44px;
        padding: 8px 12px;
        font-size: 0.9rem;
      }

      body {
        padding-bottom: 86px;
      }
    }

    @media (max-width: 640px) {
      .hero { padding-top: 20px; }
      .topbar { padding: 10px 0; }
      .hero__promo-card {
        grid-template-columns: 1fr;
        align-items: start;
        gap: 3px;
      }

      .hero__promo-card span {
        white-space: normal;
      }

      .actions .btn {
        font-size: 0.84rem;
        min-height: 48px;
        padding: 9px 8px;
      }

      .albums {
        display: flex;
        flex-wrap: nowrap;
        overflow-x: auto;
        overflow-y: hidden;
        width: 100%;
        max-width: 100%;
        padding-bottom: 2px;
        margin-bottom: 10px;
        scroll-snap-type: x proximity;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: thin;
        scrollbar-color: var(--accent) var(--meter-track);
      }

      .albums::-webkit-scrollbar {
        height: 6px;
      }

      .albums::-webkit-scrollbar-track {
        background: var(--meter-track);
        border-radius: 999px;
      }

      .albums::-webkit-scrollbar-thumb {
        background: var(--accent);
        border-radius: 999px;
      }

      .album {
        flex: 0 0 44%;
        min-width: 44%;
        max-width: 44%;
        scroll-snap-align: start;
      }

      .album img {
        aspect-ratio: 16 / 8;
      }

      .product-grid {
        grid-template-columns: 1fr;
        max-height: none;
        gap: 8px;
      }

      .product {
        display: grid;
        grid-template-columns: minmax(0, 1fr) auto;
        grid-template-areas:
          "tag qty"
          "name qty"
          "price qty";
        align-items: center;
        gap: 4px 8px;
        padding: 8px;
      }

      .product small {
        grid-area: tag;
        font-size: 0.68rem;
      }

      .product h3 {
        grid-area: name;
        font-size: 0.83rem;
        line-height: 1.22;
        margin-right: 2px;
        min-height: 0;
        max-height: none;
        overflow: visible;
        display: block;
        -webkit-line-clamp: unset;
        line-clamp: unset;
      }

      .product__price {
        grid-area: price;
        margin: 0;
        font-size: 0.82rem;
      }

      .product__price-max-discount {
        white-space: nowrap;
        font-size: 0.69rem;
      }

      .qty {
        grid-area: qty;
        margin-top: 0;
        align-self: center;
        gap: 6px;
        padding: 3px;
      }

      .qty button {
        width: 28px;
        height: 28px;
        font-size: 0.95rem;
      }

      .qty input {
        width: 28px;
      }

      .hero h1 { max-width: none; }
    }
  </style>
</head>
<body>
  <header class="topbar">
    <div class="container topbar__wrap">
      <a class="brand" href="#" aria-label="Revendedor 3Fit">
        <img src="images/logo.png" alt="Logo 3Fit" />
        <div>
          <strong>Revenda Oficial 3Fit</strong>
          <span>Melhores marmitas congeladas do Brasil</span>
        </div>
      </a>
      <div class="topbar__actions">
        <span class="pill">Disponibilidade confirmada ap√≥s envio</span>
        <button type="button" class="cart-btn" id="headerCartBtn" aria-label="Conferir pedido">
          <span aria-hidden="true">üõí</span>
          <span class="cart__count" id="headerCartCount">0</span>
        </button>
      </div>
    </div>
  </header>

  <section class="hero">
    <div class="container hero__content">
      <div class="hero__left">
        <h1>Aqui, o seu pedido <span class="hero__highlight">3Fit</span> √© <span class="hero__highlight">personalizado</span>.<br>Aproveite!</h1>
        <p>
          Selecione os pratos, ajuste quantidades e envie seu pedido üß°
        </p>
        <div class="hero__promo" id="heroPromo">
          <div class="hero__promo-card">
            <strong>Desconto progressivo</strong>
            <span>Calculando oferta...</span>
          </div>
          <div class="hero__promo-card">
            <strong>Frete gr√°tis</strong>
            <span>Calculando oferta...</span>
          </div>
        </div>
      </div>
      <div class="hero__cover">
        <img src="images/influencers.png" alt="Influenciadores e linhas 3Fit" />
      </div>
    </div>
  </section>

  <main class="container layout" id="pedidoSection">
    <section class="panel products" aria-label="Lista de produtos">
      <div id="albumGrid" class="albums" aria-label="Linhas por categoria"></div>
      <div class="album-head">
        <h3 id="albumTitle">Selecione uma linha para ver os pratos</h3>
      </div>
      <div id="productGrid" class="product-grid"></div>
    </section>

    <aside class="panel sidebar">
      <h2>Resumo do pedido</h2>
      <div class="summary" id="summary"></div>
      <div class="actions">
        <button type="button" id="clearOrderBtn" class="btn btn--ghost"><span class="clear-order-label">Limpar pedido</span><span class="clear-order-ok" aria-hidden="true">‚úì</span></button>
        <button type="button" id="reviewOrderBtn" class="btn btn--primary">Conferir pedido</button>
      </div>

      <p class="notice" id="businessNotice"></p>
      <p class="summary__disclaimer">O desconto m√°ximo varia conforme as linhas selecionadas.</p>
    </aside>
  </main>

  <div class="modal" id="reviewModal" role="dialog" aria-modal="true" aria-labelledby="reviewTitle">
    <div class="modal__card">
      <div class="modal__head">
        <h3 id="reviewTitle">Conferir pedido</h3>
        <button type="button" class="modal__close" id="closeReviewModal">Fechar</button>
      </div>
      <div class="summary" id="reviewSummary"></div>
      <div class="form">
        <textarea class="field" id="obsPedido" placeholder="Observa√ß√µes do pedido (opcional)"></textarea>
      </div>
      <div class="modal__actions">
        <button type="button" class="btn btn--ghost" id="cancelReviewBtn">Continuar escolhendo</button>
        <button type="button" class="btn btn--primary" id="sendOrderBtn">Enviar pedido</button>
      </div>
    </div>
  </div>

  <div class="mobile-dock" id="mobileDock" aria-live="polite">
    <div class="mobile-dock__meta" id="mobileDockMeta">Quanto mais marmitas&#10;Maior o desconto üí™</div>
    <div class="mobile-dock__meta-note is-hidden" id="mobileDockMetaNote">Desconto ativo</div>
    <button type="button" class="btn btn--primary" id="mobileReviewBtn" disabled>Conferir pedido</button>
    <div class="mobile-dock__meters">
      <div class="mobile-dock__meter-row">
        <span id="dockDiscountLabel">Rumo ao desconto</span>
        <span id="dockDiscountPct">0%</span>
      </div>
      <div class="mobile-dock__meter"><div class="mobile-dock__fill" id="dockDiscountFill"></div></div>
      <div class="mobile-dock__meter-row">
        <span id="dockShippingLabel">Rumo ao frete gr√°tis</span>
        <span id="dockShippingPct">0%</span>
      </div>
      <div class="mobile-dock__meter"><div class="mobile-dock__fill" id="dockShippingFill"></div></div>
    </div>
  </div>

  <div class="modal" id="alertModal" role="dialog" aria-modal="true" aria-labelledby="alertTitle">
    <div class="modal__card alert-modal__card" id="alertCard">
      <h3 id="alertTitle">Aviso</h3>
      <p class="alert-modal__message" id="alertMessage"></p>
      <div class="alert-modal__actions">
        <button type="button" class="btn btn--primary alert-modal__ok" id="alertOkBtn">OK</button>
      </div>
    </div>
  </div>

  <script src="catalog.js"></script>
  <script>
    const MAX_OBS_LENGTH = 400;
    const TECH_ERROR_MESSAGE = '<strong>Houve uma falha t√©cnica.</strong><br>Por favor, tente novamente em instantes.<br>Se o problema persistir, solicite <strong>"Atendimento humano"</strong> no WhatsApp.';
    const catalog = window.CATALOG || { version: "sem-versao", moeda: "BRL", linhas: [] };
    const lines = (catalog.linhas || []).map((line) => ({
      id: line.id,
      nome: line.nome || line.id,
      gramatura: line.gramatura || "",
      capa: line.capa,
      precoCentavos: Number.isInteger(line.precoCentavos) ? line.precoCentavos : null,
      pisoPrecoCentavos: Number.isInteger(line.pisoPrecoCentavos) ? line.pisoPrecoCentavos : null,
      itens: (line.itens || []).filter((item) => item.ativo !== false)
    }));

    const lineById = Object.fromEntries(lines.map((line) => [line.id, line]));
    const products = lines.flatMap((line) =>
      line.itens.map((item, idx) => ({
        id: item.id || `${line.id.toLowerCase()}-${idx + 1}`,
        lineId: line.id,
        lineName: line.nome,
        name: item.nome,
        precoCentavos: Number.isInteger(item.precoCentavos)
          ? item.precoCentavos
          : line.precoCentavos,
        pisoPrecoCentavos: Number.isInteger(item.pisoPrecoCentavos)
          ? item.pisoPrecoCentavos
          : line.pisoPrecoCentavos
      }))
    );

    const formatCurrency = (centavos) => {
      if (!Number.isInteger(centavos)) return "Pre√ßo a preencher";
      return new Intl.NumberFormat("pt-BR", {
        style: "currency",
        currency: catalog.moeda || "BRL",
        minimumFractionDigits: 0,
        maximumFractionDigits: 2
      })
        .format(centavos / 100);
    };

    const getMaxDiscountPercentual = () =>
      (pricingRules?.descontoProgressivo || []).reduce((max, rule) =>
        Math.max(max, Number(rule?.percentual) || 0), 0);

    const getUnitPriceWithMaxDiscountCentavos = (precoCentavos, pisoPrecoCentavos = null) => {
      if (!Number.isInteger(precoCentavos)) return null;
      const maxDiscountPercentual = getMaxDiscountPercentual();
      const fatorDesconto = Math.max(0, 1 - (maxDiscountPercentual / 100));
      const precoComDesconto = Math.round(precoCentavos * fatorDesconto);
      if (!Number.isInteger(pisoPrecoCentavos)) return precoComDesconto;
      return Math.max(precoComDesconto, pisoPrecoCentavos);
    };

    const getMinEffectiveMaxDiscountPercentual = () => {
      const effectiveDiscounts = products
        .map((product) => {
          if (!Number.isInteger(product.precoCentavos) || product.precoCentavos <= 0) return null;
          const precoNoMaxDesconto = getUnitPriceWithMaxDiscountCentavos(product.precoCentavos, product.pisoPrecoCentavos);
          if (!Number.isInteger(precoNoMaxDesconto)) return null;
          const percentual = Math.floor(((product.precoCentavos - precoNoMaxDesconto) / product.precoCentavos) * 100);
          return Math.max(0, percentual);
        })
        .filter((value) => Number.isInteger(value));

      if (!effectiveDiscounts.length) return 0;
      return Math.min(...effectiveDiscounts);
    };

    // Normaliza e valida regras comerciais vindas do features.json.
    // Retorna null quando os dados sao invalidos.
    const normalizePricingRules = (raw) => {
      if (!Array.isArray(raw?.descontoProgressivo)) return null;
      const descontoProgressivo = raw.descontoProgressivo
        .map((item) => ({
          minUnidades: Number(item?.minUnidades),
          maxUnidades: item?.maxUnidades === null ? null : Number(item?.maxUnidades),
          percentual: Number(item?.percentual)
        }))
        .filter((item) =>
          Number.isInteger(item.minUnidades)
          && item.minUnidades > 0
          && (item.maxUnidades === null || (Number.isInteger(item.maxUnidades) && item.maxUnidades >= item.minUnidades))
          && Number.isFinite(item.percentual)
          && item.percentual >= 0
        )
        .sort((a, b) => b.minUnidades - a.minUnidades);
      if (!descontoProgressivo.length) return null;

      const valorMinimoCentavos = Number(raw?.freteGratis?.valorMinimoCentavos);
      const valorFreteCentavos = Number(raw?.freteGratis?.valorFreteCentavos);
      if (!Number.isInteger(valorMinimoCentavos) || valorMinimoCentavos < 0) return null;
      if (!Number.isInteger(valorFreteCentavos) || valorFreteCentavos < 0) return null;
      const freteGratis = { valorMinimoCentavos, valorFreteCentavos };

      return { descontoProgressivo, freteGratis };
    };

    let webhookUrl = "";
    let pricingRules = null;
    let latestDockSnapshot = null;

    // Calcula o desconto ativo pela faixa de unidades e respeita pisoPrecoCentavos por item.
    const getDiscountInfo = (selectedItems, totalUnidades, totalBrutoCentavos) => {
      const rule = pricingRules.descontoProgressivo.find((item) =>
        totalUnidades >= item.minUnidades
        && (item.maxUnidades === null || totalUnidades <= item.maxUnidades)
      ) || null;
      const percentual = rule?.percentual || 0;
      const totalLiquidoCentavos = percentual > 0
        ? selectedItems.reduce((acc, item) => {
          if (!Number.isInteger(item.precoCentavos) || !Number.isFinite(item.qty)) return acc;
          const fatorDesconto = Math.max(0, 1 - (percentual / 100));
          const precoComDesconto = Math.round(item.precoCentavos * fatorDesconto);
          const precoUnitarioAplicado = Number.isInteger(item.pisoPrecoCentavos)
            ? Math.max(precoComDesconto, item.pisoPrecoCentavos)
            : precoComDesconto;
          return acc + (precoUnitarioAplicado * item.qty);
        }, 0)
        : totalBrutoCentavos;
      const descontoCentavos = Math.max(0, totalBrutoCentavos - totalLiquidoCentavos);
      return {
        percentual,
        descontoCentavos,
        totalLiquidoCentavos
      };
    };

    // Calcula elegibilidade de frete gratis e valor efetivamente cobrado.
    const getShippingInfo = (totalLiquidoCentavos) => {
      const valorMinimoCentavos = pricingRules?.freteGratis?.valorMinimoCentavos ?? 0;
      const valorFreteCentavos = pricingRules?.freteGratis?.valorFreteCentavos ?? 0;
      const elegivel = Number.isInteger(totalLiquidoCentavos) && totalLiquidoCentavos >= valorMinimoCentavos;
      const faltamCentavos = elegivel
        ? 0
        : Math.max(0, valorMinimoCentavos - (Number.isInteger(totalLiquidoCentavos) ? totalLiquidoCentavos : 0));
      const valorCobradoCentavos = elegivel ? 0 : valorFreteCentavos;

      return { valorMinimoCentavos, valorFreteCentavos, valorCobradoCentavos, elegivel, faltamCentavos };
    };

    const selected = new Map();
    const categories = lines.filter((line) => line.itens.length > 0).map((line) => line.id);

    const productGrid = document.getElementById("productGrid");
    const albumGrid = document.getElementById("albumGrid");
    const albumTitle = document.getElementById("albumTitle");
    const summary = document.getElementById("summary");
    const obsPedido = document.getElementById("obsPedido");
    const reviewOrderBtn = document.getElementById("reviewOrderBtn");
    const sendOrderBtn = document.getElementById("sendOrderBtn");
    const clearOrderBtn = document.getElementById("clearOrderBtn");
    const businessNotice = document.getElementById("businessNotice");
    const summaryDisclaimer = document.querySelector(".summary__disclaimer");
    const heroPromo = document.getElementById("heroPromo");
    const reviewModal = document.getElementById("reviewModal");
    const reviewSummary = document.getElementById("reviewSummary");
    const closeReviewModal = document.getElementById("closeReviewModal");
    const cancelReviewBtn = document.getElementById("cancelReviewBtn");
    const headerCartBtn = document.getElementById("headerCartBtn");
    const headerCartCount = document.getElementById("headerCartCount");
    const mobileDockMeta = document.getElementById("mobileDockMeta");
    const mobileDockMetaNote = document.getElementById("mobileDockMetaNote");
    const mobileReviewBtn = document.getElementById("mobileReviewBtn");
    const dockDiscountFill = document.getElementById("dockDiscountFill");
    const dockShippingFill = document.getElementById("dockShippingFill");
    const dockDiscountLabel = document.getElementById("dockDiscountLabel");
    const dockDiscountPct = document.getElementById("dockDiscountPct");
    const dockShippingLabel = document.getElementById("dockShippingLabel");
    const dockShippingPct = document.getElementById("dockShippingPct");
    const alertModal = document.getElementById("alertModal");
    const alertCard = document.getElementById("alertCard");
    const alertMessage = document.getElementById("alertMessage");
    const alertOkBtn = document.getElementById("alertOkBtn");

    const isBusinessNoticeVisible = () => {
      if (!businessNotice) return false;
      const rect = businessNotice.getBoundingClientRect();
      return rect.top < (window.innerHeight - 140) && rect.bottom > 110;
    };

    const updateSummaryDisclaimer = () => {
      if (!summaryDisclaimer) return;
      const minPercentual = getMinEffectiveMaxDiscountPercentual();
      const maxPercentual = getMaxDiscountPercentual();
      summaryDisclaimer.textContent = `O desconto m√°ximo pode variar de ${minPercentual}% a ${maxPercentual}%, a depender das linhas.`;
    };

    let activeCategory = null;
    let clearOrderFeedbackTimer = null;

    const updateBusinessNotice = (state = {}) => {
      const totalUnidades = Number.isFinite(state.totalUnidades) ? state.totalUnidades : 0;
      const descontoPercentualAtivo = Number.isFinite(state.descontoPercentualAtivo) ? state.descontoPercentualAtivo : 0;
      const totalLiquidoCentavos = Number.isInteger(state.totalLiquidoCentavos) ? state.totalLiquidoCentavos : 0;

      const rulesAsc = [...pricingRules.descontoProgressivo].sort((a, b) => a.minUnidades - b.minUnidades);
      const freteMinimoCentavos = pricingRules.freteGratis.valorMinimoCentavos;
      const freteElegivel = totalLiquidoCentavos >= freteMinimoCentavos;
      const freteFaltamCentavos = Math.max(0, freteMinimoCentavos - totalLiquidoCentavos);
      const nextDiscountRule = rulesAsc.find((rule) => totalUnidades < rule.minUnidades) || null;
      const nextHigherRule = rulesAsc.find((rule) => rule.percentual > descontoPercentualAtivo && totalUnidades < rule.minUnidades) || null;

      const maxPercentual = getMaxDiscountPercentual();
      const isMaxPercentual = (percentual) => Number(percentual) === Number(maxPercentual);
      const formatOffLabel = (percentual) =>
        isMaxPercentual(percentual) ? `at√© ${percentual}% OFF` : `${percentual}% OFF`;
      let destaqueTitulo = `Ganhe at√© ${maxPercentual}% OFF`;
      let destaqueSub = "Quanto mais marmitas no pedido<br>mais desconto no seu bolso üí™";
      let descontoStatusPrimario = "";
      let descontoStatusSecundario = "";
      if (descontoPercentualAtivo > 0 && nextHigherRule) {
        destaqueTitulo = `${formatOffLabel(descontoPercentualAtivo)} ativo`;
        destaqueSub = "Voc√™ j√° destravou desconto progressivo.";
        descontoStatusPrimario = `Desconto de ${descontoPercentualAtivo}% OFF ativo.`;
        descontoStatusSecundario = `Faltam ${Math.max(0, nextHigherRule.minUnidades - totalUnidades)} marmitas para desconto m√°ximo.`;
      } else if (descontoPercentualAtivo > 0) {
        destaqueTitulo = `${formatOffLabel(descontoPercentualAtivo)} liberado`;
        destaqueSub = "Parab√©ns, voc√™ atingiu a melhor faixa.";
        descontoStatusPrimario = "Desconto m√°ximo ativado. Aproveite! üß°";
      } else if (nextDiscountRule) {
        descontoStatusSecundario = `Faltam ${Math.max(0, nextDiscountRule.minUnidades - totalUnidades)} marmitas para ${formatOffLabel(nextDiscountRule.percentual)}.`;
      }

      const freteStatus = freteElegivel ? "Frete gr√°tis aplicado com sucesso." : `Faltam ${formatCurrency(freteFaltamCentavos)} para frete gr√°tis.`;
      const statusLinhas = [
        { mensagem: descontoStatusPrimario, hit: descontoPercentualAtivo > 0, target: false },
        { mensagem: freteStatus, hit: freteElegivel, target: false },
        { mensagem: descontoStatusSecundario, hit: false, target: true }
      ]
        .filter((item) => Boolean(item.mensagem))
        .map((item) => `<p class="offer__status ${item.hit ? "offer__status--hit" : ""} ${item.target ? "offer__status--target" : ""}">${item.mensagem}</p>`)
        .join("");
      const nextDiscountProgress = nextDiscountRule
        ? Math.max(0, Math.min(100, Math.round((totalUnidades / nextDiscountRule.minUnidades) * 100)))
        : 100;
      const freteProgress = Math.max(0, Math.min(100, Math.round((totalLiquidoCentavos / freteMinimoCentavos) * 100)));

      const discountCards = rulesAsc.map((rule) => {
        const label = rule.maxUnidades === null
          ? `${rule.minUnidades}+ marmitas`
          : `${rule.minUnidades} a ${rule.maxUnidades} marmitas`;
        const descontoLabel = rule.maxUnidades === null
          ? `<span class="offer__card-prefix">at√©</span>${rule.percentual}% OFF`
          : `${rule.percentual}% OFF`;
        const isActive = descontoPercentualAtivo >= rule.percentual && descontoPercentualAtivo > 0;
        return `
          <div class="offer__card ${isActive ? "active" : ""}">
            <strong>${label}</strong>
            <span>${descontoLabel}</span>
          </div>
        `;
      }).join("");

      businessNotice.innerHTML = `
        <div class="offer__hero">
          <p class="offer__hero-strong">${destaqueTitulo}</p>
          <p class="offer__hero-sub">${destaqueSub}</p>
        </div>
        <div class="offer__grid">
          ${discountCards}
          <div class="offer__card ${freteElegivel ? "active" : ""}">
            <strong>Frete gr√°tis</strong>
            <span>${freteElegivel ? "Aplicado!" : `Acima de ${formatCurrency(freteMinimoCentavos)}`}</span>
          </div>
        </div>
        <div class="offer__meters">
          <div class="offer__meter">
            <div class="offer__meter-top">
              <span>${nextDiscountRule ? `Rumo a ${formatOffLabel(nextDiscountRule.percentual)}` : `${formatOffLabel(rulesAsc[rulesAsc.length - 1]?.percentual || 0)} alcan√ßado`}</span>
              <span>${nextDiscountRule ? `${nextDiscountProgress}%` : "100%"}</span>
            </div>
            <div class="offer__track"><div class="offer__fill" style="width:${nextDiscountProgress}%"></div></div>
          </div>
          <div class="offer__meter">
            <div class="offer__meter-top">
              <span>${freteElegivel ? "Frete gr√°tis alcan√ßado" : "Rumo a frete gr√°tis"}</span>
              <span>${freteProgress}%</span>
            </div>
            <div class="offer__track"><div class="offer__fill" style="width:${freteProgress}%"></div></div>
          </div>
        </div>
        ${statusLinhas}
      `;
    };

    const updateHeroPromo = () => {
      const maxPercentual = getMaxDiscountPercentual();

      heroPromo.innerHTML = `
        <div class="hero__promo-card">
          <strong>Desconto progressivo</strong>
          <span>At√© ${maxPercentual}% OFF em alguns pratos</span>
        </div>
        <div class="hero__promo-card">
          <strong>Frete gr√°tis</strong>
          <span>Acima de ${formatCurrency(pricingRules.freteGratis.valorMinimoCentavos)}</span>
        </div>
      `;
    };

    // Carrega configuracao data-driven (webhook + regras) em runtime.
    const loadFeatures = async () => {
      const response = await fetch("features.json", { cache: "no-store" });
      if (!response.ok) throw new Error(`features_http_${response.status}`);

      const data = await response.json();
      const nextWebhookUrl = String(data?.webhookUrl || "").trim();
      const nextPricingRules = normalizePricingRules(data);
      if (!nextWebhookUrl) throw new Error("features_webhook_url_invalido");
      if (!nextPricingRules) throw new Error("features_pricing_rules_invalidas");

      webhookUrl = nextWebhookUrl;
      pricingRules = nextPricingRules;
    };

    const renderAlbums = () => {
      albumGrid.innerHTML = categories.map((cat) => {
        const line = lineById[cat];
        const cover = line?.capa || "images/logo.png";
        const label = line?.nome || cat;
        const gramatura = line?.gramatura || "Gramatura a definir";
        return `
          <button type="button" class="album ${cat === activeCategory ? "active" : ""}" data-album="${cat}">
            <img src="${cover}" alt="Capa ${label}" loading="lazy" onerror="this.onerror=null;this.src='images/logo.png';" />
            <div class="album__meta">
              <strong>${label}</strong>
              <span>${gramatura}</span>
            </div>
          </button>
        `;
      }).join("");
    };

    const getFilteredProducts = () => {
      if (!activeCategory) return [];
      return products.filter((product) => product.lineId === activeCategory);
    };

    const renderProducts = () => {
      const currentLineName = lineById[activeCategory]?.nome || activeCategory;
      const currentLineGramatura = lineById[activeCategory]?.gramatura || "";
      const maxDiscountPercentual = getMaxDiscountPercentual();
      albumTitle.textContent = activeCategory
        ? `Pratos da linha ${currentLineName}${currentLineGramatura ? ` (${currentLineGramatura})` : ""}`
        : "Selecione uma linha para ver os pratos";

      const filtered = getFilteredProducts();
      if (!filtered.length) {
        productGrid.innerHTML = activeCategory
          ? "<p>Nenhum prato dispon√≠vel nessa linha.</p>"
          : "";
        return;
      }

      productGrid.innerHTML = filtered.map((product) => {
        const qty = selected.get(product.id) || 0;
        const precoComMaiorDesconto = getUnitPriceWithMaxDiscountCentavos(product.precoCentavos, product.pisoPrecoCentavos);
        return `
          <article class="product">
            <small>${product.lineName}</small>
            <h3>${product.name}</h3>
            <div class="product__price">
              <span class="product__price-current">${formatCurrency(product.precoCentavos)}</span>
              <span class="product__price-max-discount">${formatCurrency(precoComMaiorDesconto)} no desconto m√°x.</span>
            </div>
            <div class="qty">
              <button type="button" data-action="minus" data-id="${product.id}" aria-label="Diminuir quantidade">-</button>
              <input type="number" min="0" value="${qty}" data-action="input" data-id="${product.id}" aria-label="Quantidade" />
              <button type="button" data-action="plus" data-id="${product.id}" aria-label="Aumentar quantidade">+</button>
            </div>
          </article>
        `;
      }).join("");
    };

    const getSelectedItems = () =>
      products
        .filter((p) => (selected.get(p.id) || 0) > 0)
        .map((p) => ({ ...p, qty: selected.get(p.id) }));

    const getOrderSnapshot = (selectedItems) => {
      const totalUnidades = selectedItems.reduce((acc, item) => acc + item.qty, 0);
      const hasMissingAnyPrice = selectedItems.some((item) => !Number.isInteger(item.precoCentavos));
      const totalBrutoCentavos = selectedItems.reduce((acc, item) => {
        if (!Number.isInteger(item.precoCentavos)) return acc;
        return acc + (item.precoCentavos * item.qty);
      }, 0);
      const discountInfo = hasMissingAnyPrice
        ? { percentual: 0, descontoCentavos: 0, totalLiquidoCentavos: null }
        : getDiscountInfo(selectedItems, totalUnidades, totalBrutoCentavos);
      const shippingInfo = hasMissingAnyPrice
        ? {
          elegivel: false,
          valorMinimoCentavos: pricingRules.freteGratis.valorMinimoCentavos,
          valorFreteCentavos: pricingRules.freteGratis.valorFreteCentavos,
          valorCobradoCentavos: null,
          faltamCentavos: null
        }
        : getShippingInfo(discountInfo.totalLiquidoCentavos);
      const totalFinalCentavos = hasMissingAnyPrice
        ? null
        : discountInfo.totalLiquidoCentavos + shippingInfo.valorCobradoCentavos;

      return { totalUnidades, hasMissingAnyPrice, totalBrutoCentavos, discountInfo, shippingInfo, totalFinalCentavos };
    };

    const buildDetailedSummaryHtml = (selectedItems, snapshot) => {
      const groupedByCategory = selectedItems.reduce((acc, item) => {
        if (!acc[item.lineId]) acc[item.lineId] = [];
        acc[item.lineId].push(item);
        return acc;
      }, {});

      const groupsHtml = Object.entries(groupedByCategory).map(([lineId, items]) => {
        const subtotal = items.reduce((acc, item) => acc + item.qty, 0);
        const subtotalCentavos = items.reduce((acc, item) => {
          if (!Number.isInteger(item.precoCentavos)) return acc;
          return acc + (item.precoCentavos * item.qty);
        }, 0);
        const hasMissingPrice = items.some((item) => !Number.isInteger(item.precoCentavos));
        const lineLabel = lineById[lineId]?.nome || lineId;
        const lineGramatura = lineById[lineId]?.gramatura || "";
        const itemLines = items
          .map((item) => {
            const itemSubtotal = Number.isInteger(item.precoCentavos) ? formatCurrency(item.precoCentavos * item.qty) : "Pre√ßo pendente";
            return `<div class="summary__line summary__line--dish"><span class="summary__item-name summary__item-name--dish" title="${item.name}">${item.name}</span><span class="summary__item-meta">x${item.qty} | ${itemSubtotal}</span></div>`;
          })
          .join("");

        return `
          <section class="summary__group">
            <div class="summary__group-title"><span class="summary__item-name">${lineLabel}${lineGramatura ? ` (${lineGramatura})` : ""}</span></div>
            ${itemLines}
            <div class="summary__subtotal"><span class="summary__item-name">Subtotal da linha</span><span class="summary__item-meta">${subtotal} un. | ${hasMissingPrice ? "Pre√ßo pendente" : formatCurrency(subtotalCentavos)}</span></div>
          </section>
        `;
      }).join("");

      const rulesAsc = [...pricingRules.descontoProgressivo].sort((a, b) => a.minUnidades - b.minUnidades);
      const maxPercentual = getMaxDiscountPercentual();
      const isMaxPercentual = (percentual) => Number(percentual) === Number(maxPercentual);
      const formatOffLabel = (percentual) =>
        isMaxPercentual(percentual) ? `at√© ${percentual}% OFF` : `${percentual}% OFF`;
      const firstRule = rulesAsc[0] || null;
      const nextDiscountRule = rulesAsc.find((rule) => snapshot.totalUnidades < rule.minUnidades) || null;
      const nextDiscountProgress = nextDiscountRule
        ? Math.max(0, Math.min(100, Math.round((snapshot.totalUnidades / nextDiscountRule.minUnidades) * 100)))
        : 100;
      const freteProgress = Math.max(
        0,
        Math.min(100, Math.round((snapshot.discountInfo.totalLiquidoCentavos / pricingRules.freteGratis.valorMinimoCentavos) * 100))
      );
      const discountMeterLabel = nextDiscountRule
        ? `Rumo a ${formatOffLabel(nextDiscountRule.percentual)}`
        : "Desconto m√°ximo aplicado";
      const shippingMeterLabel = "Rumo ao frete gr√°tis";
      const discountActiveNote = snapshot.discountInfo.percentual > 0 && nextDiscountRule
        ? `${snapshot.discountInfo.percentual}% OFF ativo!`
        : snapshot.discountInfo.percentual > 0
          ? "Desconto m√°ximo aplicado!"
          : "";
      const progressDisclaimer = !nextDiscountRule
        ? ""
        : snapshot.discountInfo.percentual > 0 && firstRule && snapshot.discountInfo.percentual >= Number(firstRule.percentual)
          ? "Adicione mais marmitas para conseguir mais desconto."
          : "Adicione mais marmitas para conseguir desconto.";
      const shippingActiveNote = snapshot.shippingInfo.elegivel
        ? "Frete gr√°tis aplicado!"
        : "";
      const pricingLines = snapshot.hasMissingAnyPrice
        ? `
          <div class="summary__line total">
            <span class="summary__item-name">Total de unidades</span>
            <span class="summary__item-meta">${snapshot.totalUnidades} | Pre√ßo pendente</span>
          </div>
        `
        : `
          <div class="summary__line total">
            <span class="summary__item-name">Total de unidades</span>
            <span class="summary__item-meta">${snapshot.totalUnidades}</span>
          </div>
          <div class="summary__line">
            <span class="summary__item-name">Total bruto</span>
            <span class="summary__item-meta">${formatCurrency(snapshot.totalBrutoCentavos)}</span>
          </div>
          <div class="summary__line">
            <span class="summary__item-name">Desconto progressivo</span>
            <span class="summary__item-meta">-${formatCurrency(snapshot.discountInfo.descontoCentavos)}</span>
          </div>
          <div class="summary__line total">
            <span class="summary__item-name">${snapshot.discountInfo.percentual > 0 ? "Total com desconto" : "Total sem desconto"}</span>
            <span class="summary__item-meta">${formatCurrency(snapshot.discountInfo.totalLiquidoCentavos)}</span>
          </div>
          <div class="summary__line">
            <span class="summary__item-name">Frete</span>
            <span class="summary__item-meta">${snapshot.shippingInfo.elegivel ? "Gr√°tis" : formatCurrency(snapshot.shippingInfo.valorCobradoCentavos)}</span>
          </div>
          <div class="summary__line total">
            <span class="summary__item-name">Total final</span>
            <span class="summary__item-meta">${formatCurrency(snapshot.totalFinalCentavos)}</span>
          </div>
          <div class="summary__meters">
            ${discountActiveNote ? `<p class="summary__meter-note">${discountActiveNote}</p>` : ""}
            ${shippingActiveNote ? `<p class="summary__meter-note">${shippingActiveNote}</p>` : ""}
            ${nextDiscountRule ? `
            <div class="summary__meter">
              <div class="summary__meter-top">
                <span>${discountMeterLabel}</span>
                <span class="summary__meter-pct">${nextDiscountProgress}%</span>
              </div>
              <div class="summary__meter-track">
                <div class="summary__meter-fill" style="width:${nextDiscountProgress}%"></div>
              </div>
            </div>` : ""}
            ${snapshot.shippingInfo.elegivel ? "" : `
            <div class="summary__meter">
              <div class="summary__meter-top">
                <span>${shippingMeterLabel}</span>
                <span class="summary__meter-pct">${freteProgress}%</span>
              </div>
              <div class="summary__meter-track">
                <div class="summary__meter-fill" style="width:${freteProgress}%"></div>
              </div>
            </div>`}
            ${progressDisclaimer ? `<p class="summary__meter-disclaimer">${progressDisclaimer}</p>` : ""}
          </div>
        `;

      return groupsHtml + pricingLines;
    };

    const renderSummary = () => {
      const selectedItems = getSelectedItems();
      if (!selectedItems.length) {
        summary.innerHTML = "<p style='margin:0;color:var(--text-soft);'>Nenhum item selecionado.</p>";
        updateBusinessNotice({ totalUnidades: 0, descontoPercentualAtivo: 0, totalLiquidoCentavos: 0 });
        latestDockSnapshot = null;
        updateMobileDock(null);
        updateHeaderCart(0);
        return;
      }

      const snapshot = getOrderSnapshot(selectedItems);
      summary.innerHTML = snapshot.hasMissingAnyPrice
        ? `
          <div class="summary__line total">
            <span class="summary__item-name">Itens selecionados</span>
            <span class="summary__item-meta">${snapshot.totalUnidades} un.</span>
          </div>
          <div class="summary__line">
            <span class="summary__item-name">Total atual</span>
            <span class="summary__item-meta">Pre√ßo pendente</span>
          </div>
          <p style="margin:6px 0 0;font-size:.76rem;color:var(--text-soft);">Toque em <strong>Conferir pedido</strong> para ver todos os detalhes.</p>
        `
        : `
          <div class="summary__line total">
            <span class="summary__item-name">Itens selecionados</span>
            <span class="summary__item-meta">${snapshot.totalUnidades} un.</span>
          </div>
          <div class="summary__line">
            <span class="summary__item-name">Desconto aplicado ${snapshot.discountInfo.percentual > 0 ? `(${snapshot.discountInfo.percentual === getMaxDiscountPercentual() ? `at√© ${snapshot.discountInfo.percentual}%` : `${snapshot.discountInfo.percentual}%`})` : ""}</span>
            <span class="summary__item-meta">${snapshot.discountInfo.percentual > 0 ? `-${formatCurrency(snapshot.discountInfo.descontoCentavos)}` : "‚Äî"}</span>
          </div>
          <div class="summary__line">
            <span class="summary__item-name">Total com desconto</span>
            <span class="summary__item-meta">${formatCurrency(snapshot.discountInfo.totalLiquidoCentavos)}</span>
          </div>
          <div class="summary__line">
            <span class="summary__item-name">Frete gr√°tis</span>
            <span class="summary__item-meta">${snapshot.shippingInfo.elegivel ? "aplicado!" : `faltam ${formatCurrency(snapshot.shippingInfo.faltamCentavos)}`}</span>
          </div>
          <p style="margin:6px 0 0;font-size:.76rem;color:var(--text-soft);">Toque em <strong>Conferir pedido</strong> para revisar e enviar.</p>
        `;

      updateBusinessNotice({
        totalUnidades: snapshot.totalUnidades,
        descontoPercentualAtivo: snapshot.discountInfo.percentual,
        totalLiquidoCentavos: Number.isInteger(snapshot.discountInfo.totalLiquidoCentavos) ? snapshot.discountInfo.totalLiquidoCentavos : 0
      });
      latestDockSnapshot = snapshot;
      updateMobileDock(snapshot);
      updateHeaderCart(snapshot.totalUnidades);
    };

    const renderReviewSummary = () => {
      const selectedItems = getSelectedItems();
      if (!selectedItems.length) {
        reviewSummary.innerHTML = "<p style='margin:0;color:var(--text-soft);'>Nenhum item selecionado.</p>";
        return;
      }
      reviewSummary.innerHTML = buildDetailedSummaryHtml(selectedItems, getOrderSnapshot(selectedItems));
    };

    const updateMobileDock = (snapshot = null) => {
      // Regras visuais do dock: mostra progresso ate o proximo objetivo;
      // quando atingir desconto maximo/frete gratis, troca barra por status aplicado.
      const rulesAsc = [...pricingRules.descontoProgressivo].sort((a, b) => a.minUnidades - b.minUnidades);
      const firstRule = rulesAsc[0] || null;
      const secondRule = rulesAsc[1] || firstRule;
      const maxPercentual = getMaxDiscountPercentual();
      const isMaxPercentual = (percentual) => Number(percentual) === Number(maxPercentual);
      const formatOffLabel = (percentual) =>
        isMaxPercentual(percentual) ? `at√© ${percentual}% OFF` : `${percentual}% OFF`;
      const noticeVisible = isBusinessNoticeVisible();
      mobileDock.classList.toggle("is-hidden", noticeVisible);
      mobileDockMeta.classList.toggle("is-hidden", noticeVisible);
      const firstDiscountActive = Boolean(
        snapshot &&
        firstRule &&
        Number(snapshot.discountInfo?.percentual || 0) >= Number(firstRule.percentual)
      );

      if (!snapshot || snapshot.totalUnidades <= 0) {
        mobileDockMetaNote.classList.add("is-hidden");
        mobileDockMeta.textContent = noticeVisible
          ? "Quanto mais marmitas\nMaior o desconto üí™"
          : "Quanto mais marmitas\nMaior o desconto üí™";
        mobileReviewBtn.disabled = true;
        dockDiscountFill.style.width = "0%";
        dockShippingFill.style.width = "0%";
        dockDiscountLabel.textContent = firstRule ? `Rumo a ${formatOffLabel(firstRule.percentual)}` : "Rumo ao desconto";
        dockShippingLabel.textContent = "Rumo ao frete gr√°tis";
        dockDiscountPct.textContent = "0%";
        dockShippingPct.textContent = "0%";
        return;
      }

      mobileReviewBtn.disabled = false;
      const nextDiscountRule = rulesAsc.find((rule) => snapshot.totalUnidades < rule.minUnidades) || null;
      const showFirstDiscountNote = firstDiscountActive && Boolean(nextDiscountRule);
      mobileDockMetaNote.classList.toggle("is-hidden", !showFirstDiscountNote || noticeVisible);
      mobileDockMetaNote.textContent = firstRule ? `${firstRule.percentual}% OFF ativo` : "Desconto ativo";
      const nextDiscountProgress = nextDiscountRule
        ? Math.max(0, Math.min(100, Math.round((snapshot.totalUnidades / nextDiscountRule.minUnidades) * 100)))
        : 100;
      const freteProgress = snapshot.hasMissingAnyPrice
        ? 0
        : Math.max(0, Math.min(100, Math.round((snapshot.discountInfo.totalLiquidoCentavos / pricingRules.freteGratis.valorMinimoCentavos) * 100)));

      dockDiscountFill.style.width = `${nextDiscountProgress}%`;
      dockShippingFill.style.width = `${freteProgress}%`;
      dockDiscountPct.textContent = `${nextDiscountProgress}%`;
      dockShippingPct.textContent = `${freteProgress}%`;
      if (nextDiscountRule) {
        dockDiscountLabel.textContent = `Rumo a ${formatOffLabel(nextDiscountRule.percentual)}`;
      } else {
        dockDiscountLabel.textContent = secondRule ? `${formatOffLabel(secondRule.percentual)} alcan√ßado` : "Desconto m√°ximo atingido";
      }
      dockShippingLabel.textContent = snapshot.shippingInfo.elegivel ? "Frete gr√°tis aplicado" : "Rumo ao frete gr√°tis";

      if (snapshot.hasMissingAnyPrice) {
        mobileDockMeta.textContent = noticeVisible
          ? "Quanto mais marmitas\nMaior o desconto üí™"
          : "Quanto mais marmitas\nMaior o desconto üí™";
        return;
      }

      if (!nextDiscountRule) {
        mobileDockMeta.innerHTML = 'Desconto m√°ximo aplicado. <span class="mobile-dock__meta-highlight">Aproveite! üß°</span>';
        return;
      }

      mobileDockMeta.textContent = noticeVisible
        ? "Quanto mais marmitas\nMaior o desconto üí™"
        : "Quanto mais marmitas\nMaior o desconto üí™";
    };

    const updateHeaderCart = (totalUnidades) => {
      const count = Number.isInteger(totalUnidades) ? totalUnidades : 0;
      headerCartCount.textContent = String(count);
      headerCartBtn.classList.toggle("has-items", count > 0);
    };

    const setQty = (id, qty) => {
      const value = Math.max(0, Number(qty) || 0);
      if (value === 0) {
        selected.delete(id);
      } else {
        selected.set(id, value);
      }
      renderProducts();
      renderSummary();
      if (reviewModal.classList.contains("show")) renderReviewSummary();
    };

    const showFeedback = (message, type = "ok") => {
      alertCard.classList.remove("ok", "error");
      alertCard.classList.add(type === "error" ? "error" : "ok");
      alertMessage.innerHTML = message;
      alertModal.classList.add("show");
    };

    const sanitizeObservation = (value) =>
      String(value || "")
        .replace(/[\u0000-\u001F\u007F]/g, " ")
        .replace(/\s+/g, " ")
        .trim()
        .slice(0, MAX_OBS_LENGTH);

    const validatePayload = (payload) => {
      if (!payload?.pedido) return { ok: false, reason: "payload_sem_pedido" };
      if (!Array.isArray(payload.pedido.itens) || payload.pedido.itens.length === 0) return { ok: false, reason: "sem_itens" };

      const hasInvalidItem = payload.pedido.itens.some((item) =>
        !item?.id
        || !Number.isInteger(item?.quantidade)
        || item.quantidade <= 0
      );
      if (hasInvalidItem) return { ok: false, reason: "item_invalido" };

      const totalFromItems = payload.pedido.itens.reduce((acc, item) => acc + item.quantidade, 0);
      if (!Number.isInteger(payload.pedido.totalUnidades) || payload.pedido.totalUnidades !== totalFromItems) {
        return { ok: false, reason: "total_unidades_inconsistente" };
      }

      return { ok: true };
    };

    // Payload enviado ao webhook/proxy.
    // Evite mudar nomes de campos sem alinhar com o consumidor backend.
    const buildPayload = () => {
      const orderItems = getSelectedItems()
        .map((product) => ({
          id: product.id,
          linhaId: product.lineId,
          linha: product.lineName,
          linhaGramatura: lineById[product.lineId]?.gramatura || "",
          produto: product.name,
          quantidade: selected.get(product.id),
          precoUnitarioCentavos: product.precoCentavos,
          subtotalCentavos: Number.isInteger(product.precoCentavos) ? product.precoCentavos * selected.get(product.id) : null
        }));

      const snapshot = getOrderSnapshot(getSelectedItems());
      const precoPendente = snapshot.hasMissingAnyPrice;
      const discountInfo = precoPendente ? null : snapshot.discountInfo;
      const shippingInfo = precoPendente ? null : snapshot.shippingInfo;

      return {
        metadata: {
          origem: "landing-page-revenda-3fit",
          geradoEm: new Date().toISOString(),
          revendedor: "Revendedor autorizado 3Fit",
          canalAtendimento: "whatsapp-agente-ia",
          catalogVersion: catalog.version,
          moeda: catalog.moeda || "BRL"
        },
        observacoesPedido: sanitizeObservation(obsPedido.value),
        pedido: {
          parametrosComerciais: {
            regrasDescontoProgressivo: pricingRules.descontoProgressivo.map((rule) => ({
              minUnidades: rule.minUnidades,
              maxUnidades: rule.maxUnidades,
              percentual: rule.percentual
            })),
            freteGratisValorMinimoCentavos: pricingRules.freteGratis.valorMinimoCentavos,
            freteValorCentavos: pricingRules.freteGratis.valorFreteCentavos
          },
          totalUnidades: snapshot.totalUnidades,
          totalBrutoCentavos: precoPendente ? null : snapshot.totalBrutoCentavos,
          descontoPercentual: discountInfo?.percentual ?? 0,
          descontoCentavos: discountInfo?.descontoCentavos ?? 0,
          totalCentavos: discountInfo?.totalLiquidoCentavos ?? (precoPendente ? null : snapshot.totalBrutoCentavos),
          totalComFreteCentavos: snapshot.totalFinalCentavos,
          freteValorCentavos: shippingInfo?.valorFreteCentavos ?? pricingRules.freteGratis.valorFreteCentavos,
          freteCobradoCentavos: shippingInfo?.valorCobradoCentavos ?? null,
          freteGratisElegivel: shippingInfo?.elegivel ?? false,
          freteGratisFaltamCentavos: shippingInfo?.faltamCentavos ?? null,
          precoPendente: precoPendente,
          itens: orderItems
        }
      };
    };

    albumGrid.addEventListener("click", (event) => {
      const button = event.target.closest("button[data-album]");
      if (!button) return;
      activeCategory = button.dataset.album;
      renderAlbums();
      renderProducts();
      productGrid.scrollIntoView({ behavior: "smooth", block: "start" });
    });

    productGrid.addEventListener("click", (event) => {
      const button = event.target.closest("button[data-action]");
      if (!button) return;
      const id = button.dataset.id;
      const current = selected.get(id) || 0;
      if (button.dataset.action === "plus") setQty(id, current + 1);
      if (button.dataset.action === "minus") setQty(id, current - 1);
    });

    productGrid.addEventListener("input", (event) => {
      const input = event.target.closest("input[data-action='input']");
      if (!input) return;
      setQty(input.dataset.id, input.value);
    });

    const animateClearOrderFeedback = () => {
      clearOrderBtn.classList.remove("is-done");
      window.clearTimeout(clearOrderFeedbackTimer);
      void clearOrderBtn.offsetWidth;
      clearOrderBtn.classList.add("is-done");
      clearOrderFeedbackTimer = window.setTimeout(() => {
        clearOrderBtn.classList.remove("is-done");
        clearOrderFeedbackTimer = null;
      }, 1200);
    };

    clearOrderBtn.addEventListener("click", () => {
      selected.clear();
      obsPedido.value = "";
      renderProducts();
      renderSummary();
      reviewModal.classList.remove("show");
      animateClearOrderFeedback();
    });

    const openReviewModal = () => {
      const selectedItems = getSelectedItems();
      if (!selectedItems.length) {
        showFeedback("Selecione pelo menos um prato antes de conferir.", "error");
        return;
      }
      renderReviewSummary();
      reviewModal.classList.add("show");
    };

    reviewOrderBtn.addEventListener("click", openReviewModal);
    mobileReviewBtn.addEventListener("click", openReviewModal);
    headerCartBtn.addEventListener("click", openReviewModal);

    closeReviewModal.addEventListener("click", () => {
      reviewModal.classList.remove("show");
    });

    cancelReviewBtn.addEventListener("click", () => {
      reviewModal.classList.remove("show");
    });

    reviewModal.addEventListener("click", (event) => {
      if (event.target === reviewModal) reviewModal.classList.remove("show");
    });

    alertOkBtn.addEventListener("click", () => {
      alertModal.classList.remove("show");
    });

    alertModal.addEventListener("click", (event) => {
      if (event.target === alertModal) alertModal.classList.remove("show");
    });

    let dockSyncTicking = false;
    const syncDockMetaWithViewport = () => {
      if (dockSyncTicking) return;
      dockSyncTicking = true;
      window.requestAnimationFrame(() => {
        updateMobileDock(latestDockSnapshot);
        dockSyncTicking = false;
      });
    };
    window.addEventListener("scroll", syncDockMetaWithViewport, { passive: true });
    window.addEventListener("resize", syncDockMetaWithViewport);

    sendOrderBtn.addEventListener("click", async () => {
      const payload = buildPayload();
      const validation = validatePayload(payload);
      if (!validation.ok) {
        console.warn("Falha de validacao de payload", validation.reason, payload);
        showFeedback(TECH_ERROR_MESSAGE, "error");
        return;
      }

      if (!webhookUrl) {
        console.warn("Webhook n√£o configurado.");
        showFeedback(TECH_ERROR_MESSAGE, "error");
        return;
      }

      const originalSendLabel = sendOrderBtn.textContent;
      sendOrderBtn.disabled = true;
      sendOrderBtn.textContent = "Enviando...";

      try {
        const response = await fetch(webhookUrl, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        if (!response.ok) {
          throw new Error(`status_${response.status}`);
        }

        showFeedback("Pedido enviado com sucesso. Em breve entraremos em contato.", "ok");
        obsPedido.value = "";
        selected.clear();
        reviewModal.classList.remove("show");
        renderProducts();
        renderSummary();
      } catch (err) {
        console.error("Falha no envio do pedido", err);
        showFeedback(TECH_ERROR_MESSAGE, "error");
      } finally {
        sendOrderBtn.disabled = false;
        sendOrderBtn.textContent = originalSendLabel;
      }
    });

    const init = async () => {
      try {
        // Fail-fast: sem features.json valido, bloqueia revisao/envio para evitar pedido com regra inconsistente.
        await loadFeatures();
      } catch (error) {
        console.error("Falha ao carregar configuracao comercial", error);
        showFeedback(TECH_ERROR_MESSAGE, "error");
        reviewOrderBtn.disabled = true;
        mobileReviewBtn.disabled = true;
        sendOrderBtn.disabled = true;
        return;
      }
      updateSummaryDisclaimer();
      updateHeroPromo();
      updateBusinessNotice();
      renderAlbums();
      renderProducts();
      renderSummary();
    };

    init();
  </script>
</body>
</html>
